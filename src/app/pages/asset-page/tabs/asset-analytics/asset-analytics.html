<section class="analytics">
  <div class="range">
    <input type="datetime-local" [(ngModel)]="from" (change)="onCustomDatesChanged()" />
    <span class="arrow">‚Üí</span>
    <input type="datetime-local" [(ngModel)]="to" (change)="onCustomDatesChanged()" />

    <div class="spacer"></div>

    <div class="more-wrap">
      <button
        type="button"
        class="more"
        (click)="togglePopover($event, 'export')"
        aria-label="–≠–∫—Å–ø–æ—Ä—Ç"
      >
        ‚ãÆ
      </button>

      <div class="popover export-pop" *ngIf="openPopover === 'export'" (click)="$event.stopPropagation()">
        <button class="pop-item" type="button" (click)="exportPdf()">–°–∫–∞—á–∞—Ç—å PDF</button>
        <button class="pop-item" type="button" (click)="exportExcel()">–°–∫–∞—á–∞—Ç—å Excel (CSV)</button>
      </div>
    </div>
  </div>

  <div class="presets">
    <button type="button" [class.active]="preset==='day'" (click)="setPreset('day')">–î–µ–Ω—å</button>
    <button type="button" [class.active]="preset==='week'" (click)="setPreset('week')">–ù–µ–¥–µ–ª—è</button>
    <button type="button" [class.active]="preset==='2w'" (click)="setPreset('2w')">2 –Ω–µ–¥–µ–ª–∏</button>
    <button type="button" [class.active]="preset==='month'" (click)="setPreset('month')">–ú–µ—Å—è—Ü</button>
    <button type="button" [class.active]="preset==='3m'" (click)="setPreset('3m')">3 –º–µ—Å—è—Ü–∞</button>
    <button type="button" [class.active]="preset==='6m'" (click)="setPreset('6m')">–ü–æ–ª–≥–æ–¥–∞</button>
  </div>

  <table class="table">
    <thead>
      <tr>
        <th class="th th-sort" (click)="toggleSort()">
          <div class="th-inner">
            <span>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</span>
            <span class="sort">{{ sortDir }}</span>
          </div>
        </th>

        <th class="th">
          <div class="th-inner">
            <span>–í–∏–¥ —Ä–∞–±–æ—Ç</span>
            <button
              class="th-btn"
              type="button"
              (click)="togglePopover($event, 'workType')"
              aria-label="–§–∏–ª—å—Ç—Ä –ø–æ –≤–∏–¥—É —Ä–∞–±–æ—Ç"
            >
              ‚ñæ
            </button>
          </div>

          <div class="popover" *ngIf="openPopover === 'workType'" (click)="$event.stopPropagation()">
            <button class="pop-item" type="button" (click)="setWorkType('')">–í—Å–µ</button>
            <button
              class="pop-item"
              type="button"
              *ngFor="let t of workTypes"
              (click)="setWorkType(t)"
            >
              {{ t }}
            </button>
          </div>
        </th>

        <th class="th">
          <div class="th-inner">
            <span>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ</span>
            <button
              class="th-btn"
              type="button"
              (click)="togglePopover($event, 'details')"
              aria-label="–ü–æ–∏—Å–∫ –ø–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏"
            >
              üîç
            </button>
          </div>

          <div class="popover pop-search" *ngIf="openPopover==='details'" (click)="$event.stopPropagation()">
            <input
              class="pop-input"
              type="text"
              [(ngModel)]="detailsQuery"
              (input)="apply()"
              placeholder="–ü–æ–∏—Å–∫‚Ä¶"
            />
            <button class="pop-item" type="button" (click)="detailsQuery=''; apply(); openPopover=null">
              –û—á–∏—Å—Ç–∏—Ç—å
            </button>
          </div>
        </th>

        <th class="th">
          <div class="th-inner">
            <span>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
            <button
              class="th-btn"
              type="button"
              (click)="togglePopover($event, 'user')"
              aria-label="–§–∏–ª—å—Ç—Ä –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é"
            >
              ‚ñæ
            </button>
          </div>

          <div class="popover" *ngIf="openPopover === 'user'" (click)="$event.stopPropagation()">
            <button class="pop-item" type="button" (click)="setUser('')">–í—Å–µ</button>
            <button
              class="pop-item"
              type="button"
              *ngFor="let u of users"
              (click)="setUser(u)"
            >
              {{ u }}
            </button>
          </div>
        </th>
      </tr>
    </thead>

    <tbody>
      <tr *ngFor="let e of visibleEvents">
        <td>{{ formatTs(e.ts) }}</td>
        <td>{{ e.type }}</td>
        <td>{{ e.result }}</td>
        <td class="user">{{ e.userLogin }}</td>
      </tr>

      <tr *ngIf="visibleEvents.length === 0">
        <td colspan="4">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞/—Ñ–∏–ª—å—Ç—Ä–æ–≤</td>
      </tr>
    </tbody>
  </table>
</section>
